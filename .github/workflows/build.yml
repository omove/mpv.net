name: Build (x64 + arm64)

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    strategy:
      matrix:
        arch: [ win-x64, win-arm64 ]

    env:
      CONFIGURATION: Release

    steps:
      # Checkout
      - uses: actions/checkout@v4

      # Setup .NET
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # Restore
      - name: Restore
        run: dotnet restore ./src/mpv.net.sln -r ${{ matrix.arch }}

      # Publish
      - name: Publish ${{ matrix.arch }}
        run: dotnet publish ./src/mpv.net/mpv.net.csproj `
              -c Release `
              -r ${{ matrix.arch }} `
              --self-contained false `
              -o publish/${{ matrix.arch }}

      # Create Portable ZIP
      - name: Create Portable ZIP
        shell: powershell
        run: |
          $out = "artifacts/${{ matrix.arch }}"
          New-Item -ItemType Directory -Force -Path $out
          Compress-Archive `
            -Path publish/${{ matrix.arch }}/* `
            -DestinationPath "$out/mpv.net-${{ matrix.arch }}-portable.zip"

      # Install Inno Setup
      - name: Install Inno Setup
        run: choco install innosetup --yes

      # Build Installer
      - name: Build Installer (${{ matrix.arch }})
        shell: powershell
        run: |
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          $platform = "${{ matrix.arch }}" -replace "win-", ""
          & "$iscc" `
            "/DMyAppVersion=${{ github.ref_name || github.sha }}" `
            "/DSourceDir=$PWD\publish\${{ matrix.arch }}" `
            "/DPlatform=$platform" `
            "src\Setup\Inno\inno-setup.iss"

          Move-Item `
            "src\Setup\Inno\Output\*.exe" `
            "artifacts/${{ matrix.arch }}/"

      # Upload artifacts
      - uses: actions/upload-artifact@v4
        with:
          name: mpv.net-${{ matrix.arch }}
          path: artifacts/${{ matrix.arch }}
