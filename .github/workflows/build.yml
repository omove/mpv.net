name: Build

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        arch: [ win-x64, win-arm64 ]

    env:
      configuration: Debug

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install 7-Zip
        run: choco install 7zip --yes

      - name: Restore
        run: dotnet restore ./src/MpvNet.sln -r ${{ matrix.arch }}

      - name: Publish ${{ matrix.arch }}
        run: dotnet publish ./src/MpvNet.Windows/MpvNet.Windows.csproj `
              -c ${{ env.configuration }} `
              -r ${{ matrix.arch }} `
              --self-contained false `
              -o src/MpvNet.Windows/bin/Debug/

      - name: Create .mo files for localization
        shell: powershell
        run: |
          # Install the Gettext.Tools PowerShell package
          Install-Package Gettext.Tools -Force

          # Add the tools to PATH
          $env:Path = ((Get-Package Gettext.Tools).Source | Split-Path) + '\tools\bin;' + $env:Path

          # Run the existing script that compiles .po â†’ .mo
          .\lang\create-mo-files.ps1

          # Copy the resulting .mo files into the publish folder
          Copy-Item .\lang\mo\* src\MpvNet.Windows\bin\Debug\lang -Recurse -Force

      - name: Download libmpv
        shell: powershell
        run: |
          if ("${{ matrix.arch }}" -eq "win-x64") {
            $url = "https://github.com/zhongfly/mpv-winbuild/releases/download/2026-02-20-f7ad4a5/mpv-dev-x86_64-20260220-git-f7ad4a5.7z"
          } else {
            $url = "https://github.com/zhongfly/mpv-winbuild/releases/download/2026-02-20-f7ad4a5/mpv-dev-aarch64-20260220-git-f7ad4a5.7z"
          }

          Invoke-WebRequest $url -OutFile libmpv.7z
          & "C:\Program Files\7-Zip\7z.exe" x libmpv.7z -aoa -o"libmpv"

          Copy-Item libmpv\libmpv-2.dll src/MpvNet.Windows/bin/Debug/ -Force

      - name: Download MediaInfo
        shell: powershell
        run: |
          if ("${{ matrix.arch }}" -eq "win-x64") {
            $url = "https://mediaarea.net/download/binary/libmediainfo0/26.01/MediaInfo_DLL_26.01_Windows_x64_WithoutInstaller.7z"
          } else {
            $url = "https://mediaarea.net/download/binary/libmediainfo0/26.01/MediaInfo_DLL_26.01_Windows_ARM64_WithoutInstaller.7z"
          }

          Invoke-WebRequest $url -OutFile MediaInfo.7z
          & "C:\Program Files\7-Zip\7z.exe" x MediaInfo.7z -aoa -o"MediaInfo"

          Copy-Item MediaInfo\MediaInfo.dll src/MpvNet.Windows/bin/Debug/ -Force

      - name: Download mpvnet.com
        shell: powershell
        run: |
          Invoke-WebRequest `
            -Uri "https://github.com/mpvnet-player/file-host/releases/download/tag/mpvnet.com.txt" `
            -OutFile "mpvnet.com"

          Copy-Item mpvnet.com src/MpvNet.Windows/bin/Debug/ -Force

      - name: Create Portable ZIP
        shell: powershell
        run: |
          $out = "artifacts/${{ matrix.arch }}"
          New-Item -ItemType Directory -Force -Path $out
          Compress-Archive `
            -Path src/MpvNet.Windows/bin/Debug/* `
            -DestinationPath "$out/mpv.net-${{ matrix.arch }}-portable.zip"

      - name: Install Inno Setup
        run: choco install innosetup --yes

      - name: Build Installer (${{ matrix.arch }})
        shell: powershell
        run: |
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          $platform = "${{ matrix.arch }}" -replace "win-", ""
          & "$iscc" `
            "/DMyAppVersion=${{ github.ref_name || github.sha }}" `
            "/DPlatform=$platform" `
            "src\Setup\Inno\inno-setup.iss"

          Move-Item `
            "src\Setup\Inno\Output\*.exe" `
            "artifacts/${{ matrix.arch }}/"

      - uses: actions/upload-artifact@v4
        with:
          name: mpv.net-${{ matrix.arch }}
          path: artifacts/${{ matrix.arch }}
