name: mpvnet build

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        arch: [ win-x64, win-arm64 ]

    env:
      configuration: Release

    steps:
      # Checkout
      - uses: actions/checkout@v4

      # Setup .NET
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install 7-Zip
        run: choco install 7zip --yes

      # Restore
      - name: Restore
        run: dotnet restore ./src/MpvNet.sln -r ${{ matrix.arch }}

      # Publish
      - name: Publish ${{ matrix.arch }}
        run: dotnet publish ./src/MpvNet.Windows/MpvNet.Windows.csproj `
              -c ${{ env.configuration }} `
              -r ${{ matrix.arch }} `
              --self-contained false `
              -o publish/${{ matrix.arch }}

      - name: Download libmpv
        shell: powershell
        run: |
          if ("${{ matrix.arch }}" -eq "win-x64") {
            $url = "https://github.com/zhongfly/mpv-winbuild/releases/download/2026-02-20-f7ad4a5/mpv-dev-x86_64-20260220-git-f7ad4a5.7z"
          } else {
            $url = "https://github.com/zhongfly/mpv-winbuild/releases/download/2026-02-20-f7ad4a5/mpv-dev-aarch64-20260220-git-f7ad4a5.7z"
          }

          Invoke-WebRequest $url -OutFile libmpv.7z
          & "C:\Program Files\7-Zip\7z.exe" x libmpv.7z -aoa -o"libmpv"

          Copy-Item libmpv\*\*.dll publish/${{ matrix.arch }} -Recurse -Force

      - name: Download MediaInfo
        shell: powershell
        run: |
          if ("${{ matrix.arch }}" -eq "win-x64") {
            $url = "https://mediaarea.net/download/binary/libmediainfo0/26.01/MediaInfo_DLL_26.01_Windows_x64_WithoutInstaller.7z"
          } else {
            $url = "https://mediaarea.net/download/binary/libmediainfo0/26.01/MediaInfo_DLL_26.01_Windows_ARM64_WithoutInstaller.7z"
          }

          Invoke-WebRequest $url -OutFile mediainfo.7z
          & "C:\Program Files\7-Zip\7z.exe" x mediainfo.7z -aoa -o"mediainfo"

          Copy-Item mediainfo\*\MediaInfo.dll publish/${{ matrix.arch }} -Force

      - name: Download mpvnet.com
        shell: powershell
        run: |
          Invoke-WebRequest `
            -Uri "https://github.com/mpvnet-player/file-host/releases/download/tag/mpvnet.com.txt" `
            -OutFile "mpvnet.com"

          Copy-Item mpvnet.com publish/${{ matrix.arch }}/mpvnet.com -Force

      # Create Portable ZIP
      - name: Create Portable ZIP
        shell: powershell
        run: |
          $out = "artifacts/${{ matrix.arch }}"
          New-Item -ItemType Directory -Force -Path $out
          Compress-Archive `
            -Path publish/${{ matrix.arch }}/* `
            -DestinationPath "$out/mpv.net-${{ matrix.arch }}-portable.zip"

      # Install Inno Setup
      - name: Install Inno Setup
        run: choco install innosetup --yes

      # Build Installer
      - name: Build Installer (${{ matrix.arch }})
        shell: powershell
        run: |
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          $platform = "${{ matrix.arch }}" -replace "win-", ""
          & "$iscc" `
            "/DMyAppVersion=${{ github.ref_name || github.sha }}" `
            "/DSourceDir=$PWD\publish\${{ matrix.arch }}" `
            "/DPlatform=$platform" `
            "src\Setup\Inno\inno-setup.iss"

          Move-Item `
            "src\Setup\Inno\Output\*.exe" `
            "artifacts/${{ matrix.arch }}/"

      # Upload artifacts
      - uses: actions/upload-artifact@v4
        with:
          name: mpv.net-${{ matrix.arch }}
          path: artifacts/${{ matrix.arch }}
